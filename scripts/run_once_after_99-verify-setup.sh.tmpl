#!/bin/bash

set -euo pipefail

{{- if eq .chezmoi.os "darwin" }}
#
# Verify development environment setup (macOS)
#

echo "ğŸ” Verifying development environment setup..."

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

success_count=0
total_checks=0

check_command() {
    local cmd="$1"
    local description="$2"
    total_checks=$((total_checks + 1))

    if command -v "$cmd" >/dev/null 2>&1; then
        echo -e "${GREEN}âœ… $description${NC}"
        success_count=$((success_count + 1))
    else
        echo -e "${RED}âŒ $description - $cmd not found${NC}"
    fi
}

check_path() {
    local path="$1"
    local description="$2"
    total_checks=$((total_checks + 1))

    if [[ -e "$path" ]]; then
        echo -e "${GREEN}âœ… $description${NC}"
        success_count=$((success_count + 1))
    else
        echo -e "${RED}âŒ $description - $path not found${NC}"
    fi
}

echo ""
echo "ğŸ“¦ Core Development Tools:"
check_command "brew" "Homebrew package manager"
check_command "git" "Git version control"
check_command "python3" "Python 3"
check_command "asdf" "ASDF version manager"

echo ""
echo "â˜ï¸ Cloud & DevOps Tools:"
check_command "aws" "AWS CLI"
check_command "aws-vault" "AWS Vault"
check_command "kubectl" "Kubernetes CLI"
check_command "helm" "Helm package manager"
check_command "docker" "Docker"

echo ""
echo "ğŸ› ï¸ Command Line Utilities:"
check_command "jq" "JSON processor"
check_command "htop" "System monitor"
check_command "tmux" "Terminal multiplexer"
check_command "fd" "Modern find replacement"
check_command "exa" "Modern ls replacement"

echo ""
echo "ğŸš Shell Environment:"
check_command "zsh" "Zsh shell"
check_path "$HOME/.zsh" "Zsh configuration directory"
check_path "$HOME/.p10k.zsh" "Powerlevel10k configuration"

echo ""
echo "ğŸ¯ GUI Applications:"
check_path "/Applications/Visual Studio Code.app" "Visual Studio Code"
check_path "/Applications/Docker.app" "Docker Desktop"

if [[ -f "$HOME/.local/share/zinit/zinit.git/zinit.zsh" ]]; then
    echo -e "${GREEN}âœ… Zinit plugin manager${NC}"
    success_count=$((success_count + 1))
else
    echo -e "${RED}âŒ Zinit plugin manager${NC}"
fi
total_checks=$((total_checks + 1))

echo ""
echo "ğŸ“¦ Homebrew Bundle Status:"
if command -v brew >/dev/null 2>&1; then
    cd "$HOME/.local/share/chezmoi" 2>/dev/null || cd "$PWD"
    if [[ -f "Brewfile" ]]; then
        echo -e "${GREEN}âœ… Brewfile found${NC}"
        brew bundle check --verbose --file Brewfile 2>/dev/null && echo -e "${GREEN}âœ… All Brewfile packages installed${NC}" || echo -e "${YELLOW}âš ï¸  Some Brewfile packages missing${NC}"
        success_count=$((success_count + 1))
    else
        echo -e "${RED}âŒ Brewfile not found${NC}"
    fi
    total_checks=$((total_checks + 1))
fi

echo ""
echo "ğŸ“Š Verification Summary:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [[ $success_count -eq $total_checks ]]; then
    echo -e "${GREEN}ğŸ‰ All checks passed! ($success_count/$total_checks)${NC}"
    echo -e "${GREEN}Your development environment is ready to use!${NC}"
elif [[ $success_count -gt $((total_checks * 3 / 4)) ]]; then
    echo -e "${YELLOW}âš ï¸  Most checks passed ($success_count/$total_checks)${NC}"
    echo -e "${YELLOW}Your environment is mostly ready, but some optional tools are missing.${NC}"
else
    echo -e "${RED}âŒ Several checks failed ($success_count/$total_checks)${NC}"
    echo -e "${RED}Please review the failed items and reinstall if necessary.${NC}"
fi

echo ""
echo "ğŸ’¡ Next steps:"
echo "   â€¢ Restart your terminal or run: source ~/.zshrc"
echo "   â€¢ Configure your applications (VS Code, Git, etc.)"
echo "   â€¢ Run 'chezmoi doctor' to check for any chezmoi issues"

echo ""
echo "ğŸ”§ Troubleshooting:"
echo "   â€¢ If commands are not found, check your PATH with: echo \$PATH"
echo "   â€¢ For missing packages, run: brew bundle install"
echo "   â€¢ To check what's missing: brew bundle check --verbose"
echo "   â€¢ Run 'brew doctor' to diagnose Homebrew issues"
echo "   â€¢ For GUI apps, check Applications folder or reinstall with: brew bundle install --force"
{{- end }}

{{- if eq .chezmoi.os "linux" }}
echo "ğŸ” Verifying Linux development environment..."

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

success_count=0
total_checks=0

check_command() {
    local cmd="$1"
    local description="$2"
    total_checks=$((total_checks + 1))

    if command -v "$cmd" >/dev/null 2>&1; then
        echo -e "${GREEN}âœ… $description${NC}"
        success_count=$((success_count + 1))
    else
        echo -e "${RED}âŒ $description - $cmd not found${NC}"
    fi
}

check_path() {
    local path="$1"
    local description="$2"
    total_checks=$((total_checks + 1))

    if [[ -e "$path" ]]; then
        echo -e "${GREEN}âœ… $description${NC}"
        success_count=$((success_count + 1))
    else
        echo -e "${RED}âŒ $description - $path not found${NC}"
    fi
}

check_group_membership() {
    local group="$1"
    local description="$2"
    total_checks=$((total_checks + 1))

    if id -nG "$USER" | grep -qw "$group"; then
        echo -e "${GREEN}âœ… $description${NC}"
        success_count=$((success_count + 1))
    else
        echo -e "${YELLOW}âš ï¸  $description - re-login may be required${NC}"
    fi
}

echo ""
echo "ğŸ“¦ Core Development Tools:"
check_command "git" "Git version control"
check_command "python3" "Python 3"
check_command "python" "python"
check_command "zsh" "Zsh shell"

echo ""
echo "ğŸ› ï¸ Command Line Utilities:"
check_command "tmux" "tmux"
check_command "jq" "jq JSON processor"
check_command "htop" "htop system monitor"
check_command "fd" "fd modern find (or symlink)"
check_command "rg" "ripgrep search"
check_command "fzf" "fzf fuzzy finder"
check_command "eza" "eza modern ls (optional)"
check_command "bat" "bat pager"

echo ""
echo "ğŸš Shell Environment:"
check_path "$HOME/.zsh" "Zsh configuration directory"
check_command "zoxide" "zoxide directory jumper"
if [[ -f "$HOME/.local/share/zinit/zinit.git/zinit.zsh" ]]; then
    echo -e "${GREEN}âœ… Zinit plugin manager${NC}"
    success_count=$((success_count + 1))
else
    echo -e "${RED}âŒ Zinit plugin manager not found${NC}"
fi
total_checks=$((total_checks + 1))

echo ""
echo "ğŸ³ Container Runtime:"
check_group_membership "docker" "User added to docker group"

echo ""
echo "ğŸ“‚ Paths & Directories:"
check_path "$HOME/.local/bin" "~/.local/bin exists"
check_path "$HOME/.config/chezmoi" "chezmoi config directory"

echo ""
echo "ğŸ“Š Verification Summary:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [[ $success_count -eq $total_checks ]]; then
    echo -e "${GREEN}ğŸ‰ All checks passed! ($success_count/$total_checks)${NC}"
elif [[ $success_count -gt $((total_checks * 3 / 4)) ]]; then
    echo -e "${YELLOW}âš ï¸  Most checks passed ($success_count/$total_checks)${NC}"
else
    echo -e "${RED}âŒ Several checks failed ($success_count/$total_checks)${NC}"
fi

echo ""
echo "ğŸ’¡ Next steps:"
echo "   â€¢ Restart your session or run 'newgrp docker' if Docker group check failed"
echo "   â€¢ Run 'chezmoi apply' after adjusting any missing tools"
echo "   â€¢ Install optional GUI apps manually as needed"
{{- end }}
