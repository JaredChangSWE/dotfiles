#!/bin/bash

#
# One-time setup for development tools and special configurations
#

set -euo pipefail

eval "$(/opt/homebrew/bin/brew shellenv)"

echo "ðŸ”§ Setting up development environment..."

# Initial Brewfile installation
echo "ðŸ“¦ Initial installation from Brewfile.darwin..."
cd "{{ .chezmoi.sourceDir }}"
if brew bundle --verbose --file Brewfile.darwin; then
    echo "âœ… Initial Brewfile installation completed!"
else
    echo "âŒ Some packages failed to install. Continuing with setup..."
fi

# Special setup tasks that only need to run once
echo "ðŸ”§ Setting up AWS Session Manager..."
if ! command -v session-manager-plugin >/dev/null 2>&1; then
    echo "Installing AWS Session Manager plugin..."
    curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/mac/sessionmanager-bundle.zip" -o "sessionmanager-bundle.zip"
    unzip sessionmanager-bundle.zip
    sudo ./sessionmanager-bundle/install -i /usr/local/sessionmanagerplugin -b /usr/local/bin/session-manager-plugin
    rm ./sessionmanager-bundle.zip
    rm -rf ./sessionmanager-bundle
    echo "âœ… AWS Session Manager plugin installed"
else
    echo "âœ… AWS Session Manager plugin already installed"
fi

echo "ðŸ” Configuring AWS Vault keychain..."
security list-keychains -s `security list-keychains | xargs` ~/Library/Keychains/aws-vault.keychain-db 2>/dev/null || true
security set-keychain-settings ~/Library/Keychains/aws-vault.keychain-db 2>/dev/null || true
echo "âœ… AWS Vault keychain configured"

echo "ðŸŽ‰ Development tools setup completed!"
echo ""
echo "ðŸ’¡ Next steps:"
echo "   â€¢ Restart your terminal to ensure all PATH changes take effect"
echo "   â€¢ Run the verification script to check the installation"
echo "   â€¢ Configure your newly installed applications"
echo "   â€¢ Future Brewfile.darwin changes will be handled automatically by modify_Brewfile.sh"
